<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理後台 - Bible Bot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1e293b;
        }

        /* 側邊欄 */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px 0;
            box-shadow: 4px 0 24px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 25px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            text-decoration: none;
        }

        .sidebar-logo-icon {
            width: 42px;
            height: 42px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .sidebar-logo-text h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .sidebar-logo-text p {
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .sidebar-menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .sidebar-menu-item:hover {
            background: rgba(255,255,255,0.08);
            color: white;
        }

        .sidebar-menu-item.active {
            background: rgba(255,255,255,0.12);
            color: white;
            border-left-color: white;
        }

        .sidebar-menu-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            padding: 0 25px;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.15);
        }

        /* 主內容區 */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }

        .top-bar {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar-title h2 {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
        }

        .top-bar-title p {
            font-size: 14px;
            color: #64748b;
            margin-top: 4px;
        }

        .top-bar-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .content-area {
            padding: 40px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 統計卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-card-icon.blue {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }

        .stat-card-icon.green {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        .stat-card-icon.purple {
            background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);
        }

        .stat-card-icon.orange {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        }

        .stat-card-body h3 {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 800;
            color: #0f172a;
            line-height: 1;
        }

        /* 圖表容器 */
        .chart-container {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }

        .chart-header {
            margin-bottom: 24px;
        }

        .chart-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
        }

        .chart-header p {
            font-size: 14px;
            color: #64748b;
            margin-top: 4px;
        }

        /* 搜尋框 */
        .search-box {
            width: 100%;
            padding: 14px 18px 14px 48px;
            font-size: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 24px;
            background: white url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2394a3b8" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 16px center;
            transition: all 0.2s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* 表格 */
        .table-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8fafc;
        }

        th {
            padding: 16px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 18px 20px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #334155;
        }

        tr:hover {
            background: #f8fafc;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .user-name {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .user-id {
            font-size: 12px;
            color: #94a3b8;
            font-family: 'Courier New', monospace;
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .badge-canonical {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
        }

        .badge-balanced {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }

        .badge-none {
            background: #f1f5f9;
            color: #64748b;
        }

        .progress-bar {
            width: 120px;
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f1f5f9;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: linear-gradient(135deg, #fee 0%, #fdd 100%);
            color: #c53030;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid rgba(197, 48, 48, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* 操作按鈕 */
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .action-btn-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }

        .action-btn-warning:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
        }

        .action-btn-danger {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
        }

        .action-btn-danger:hover {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .content-area {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 側邊欄 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <div class="sidebar-logo-icon">📖</div>
                <div class="sidebar-logo-text">
                    <h1>Bible Bot</h1>
                    <p>管理後台</p>
                </div>
            </a>
        </div>

        <nav class="sidebar-menu">
            <div class="sidebar-menu-item active" onclick="switchTab('dashboard')">
                <span class="sidebar-menu-icon">📊</span>
                <span>儀表板</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTab('users')">
                <span class="sidebar-menu-icon">👥</span>
                <span>使用者列表</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTab('statistics')">
                <span class="sidebar-menu-icon">📈</span>
                <span>統計報表</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTab('export')">
                <span class="sidebar-menu-icon">💾</span>
                <span>資料匯出</span>
            </div>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()">
                <span>🚪</span>
                <span>登出</span>
            </button>
        </div>
    </div>

    <!-- 主內容區 -->
    <div class="main-content">
        <!-- 頂部欄 -->
        <div class="top-bar">
            <div class="top-bar-title">
                <h2 id="pageTitle">儀表板</h2>
                <p id="pageSubtitle">總覽所有讀經進度與統計資料</p>
            </div>
            <div class="top-bar-actions">
                <button class="btn btn-secondary" onclick="location.reload()">
                    🔄 重新整理
                </button>
            </div>
        </div>

        <!-- 內容區域 -->
        <div class="content-area">
            <!-- 儀表板 -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid" id="statsGrid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>載入中...</p>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>讀經計畫分布</h3>
                        <p>各讀經計畫的使用者人數統計</p>
                    </div>
                    <canvas id="planChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>進度分布</h3>
                        <p>使用者閱讀進度的分布情況</p>
                    </div>
                    <canvas id="progressChart"></canvas>
                </div>
            </div>

            <!-- 使用者列表 -->
            <div id="users" class="tab-content">
                <input type="text" class="search-box" id="searchBox" placeholder="搜尋使用者名稱或 LINE ID...">
                
                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <button class="btn btn-secondary" onclick="sortUsers('current_day', 'desc')">
                        📊 依進度排序
                    </button>
                    <button class="btn btn-secondary" onclick="sortUsers('last_read_date', 'desc')">
                        📅 依最後閱讀排序
                    </button>
                </div>

                <div id="usersTable">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>載入中...</p>
                    </div>
                </div>
            </div>

            <!-- 統計報表 -->
            <div id="statistics" class="tab-content">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>完成度統計</h3>
                        <p>各進度區間的使用者分布</p>
                    </div>
                    <div id="completionStats">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>載入中...</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>活躍度趨勢</h3>
                        <p>今日、本週、本月的活躍使用者數</p>
                    </div>
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <!-- 資料匯出 -->
            <div id="export" class="tab-content">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>資料匯出</h3>
                        <p>匯出所有使用者資料和統計報表為 CSV 格式</p>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-bottom: 32px;">
                        <button class="btn btn-primary" onclick="exportUsers()">
                            📥 匯出使用者資料
                        </button>
                        <button class="btn btn-primary" onclick="exportStats()">
                            📥 匯出統計報表
                        </button>
                    </div>

                    <div style="background: #f8fafc; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #0f172a; margin-bottom: 16px;">📋 匯出說明</h4>
                        <ul style="list-style: none; padding: 0; color: #475569; line-height: 1.8;">
                            <li style="margin-bottom: 8px;">• <strong>使用者資料</strong>：包含所有使用者的名稱、LINE ID、讀經計畫、進度、日期等資訊</li>
                            <li style="margin-bottom: 8px;">• <strong>統計報表</strong>：包含總覽統計、計畫分布、進度分布等彙總資料</li>
                            <li>• 匯出的 CSV 檔案使用 UTF-8 編碼，可直接用 Excel 開啟</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // 認證檢查
        const adminAuth = sessionStorage.getItem('adminAuth');
        if (!adminAuth) {
            window.location.href = '/admin/login';
        }

        // 全域變數
        const authHeader = 'Basic ' + adminAuth;
        let statsData = null;
        let usersData = null;
        let currentSort = { by: 'current_day', order: 'desc' };

        // 切換分頁
        function switchTab(tabName) {
            // 更新側邊欄選中狀態
            document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.sidebar-menu-item').classList.add('active');

            // 更新頂部標題
            const titles = {
                'dashboard': { title: '儀表板', subtitle: '總覽所有讀經進度與統計資料' },
                'users': { title: '使用者列表', subtitle: '查看所有使用者的詳細資料' },
                'statistics': { title: '統計報表', subtitle: '深入分析讀經進度與活躍度' },
                'export': { title: '資料匯出', subtitle: '匯出使用者資料和統計報表' }
            };
            document.getElementById('pageTitle').textContent = titles[tabName].title;
            document.getElementById('pageSubtitle').textContent = titles[tabName].subtitle;

            // 切換內容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // 載入對應資料
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'statistics') {
                loadStatistics();
            }
        }

        // 載入儀表板
        async function loadDashboard() {
            try {
                const response = await fetch('/admin/stats/overview', {
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) throw new Error('載入失敗');

                statsData = await response.json();

                // 顯示統計卡片
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon blue">👥</div>
                        </div>
                        <div class="stat-card-body">
                            <h3>總使用者數</h3>
                            <div class="stat-card-value">${statsData.total_users}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon green">📅</div>
                        </div>
                        <div class="stat-card-body">
                            <h3>今日活躍</h3>
                            <div class="stat-card-value">${statsData.active_today}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon purple">📊</div>
                        </div>
                        <div class="stat-card-body">
                            <h3>本週活躍</h3>
                            <div class="stat-card-value">${statsData.active_week}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon orange">🎯</div>
                        </div>
                        <div class="stat-card-body">
                            <h3>平均進度</h3>
                            <div class="stat-card-value">${statsData.avg_progress}<span style="font-size: 18px; margin-left: 4px;">天</span></div>
                        </div>
                    </div>
                `;

                // 繪製圖表
                drawPlanChart();
                drawProgressChart();

            } catch (error) {
                document.getElementById('statsGrid').innerHTML = 
                    `<div class="error">❌ 載入失敗：${error.message}</div>`;
            }
        }

        // 繪製計畫分布圖
        function drawPlanChart() {
            const ctx = document.getElementById('planChart');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statsData.plan_distribution).map(key => {
                        return key === 'Canonical' ? '按卷順序計畫' : 
                               key === 'Balanced' ? '平衡讀經計畫' : key;
                    }),
                    datasets: [{
                        data: Object.values(statsData.plan_distribution),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(52, 211, 153, 0.8)',
                            'rgba(251, 146, 60, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: { size: 14, family: 'Inter' }
                            }
                        }
                    }
                }
            });
        }

        // 繪製進度分布圖
        function drawProgressChart() {
            const ctx = document.getElementById('progressChart');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(statsData.progress_distribution),
                    datasets: [{
                        label: '使用者數',
                        data: Object.values(statsData.progress_distribution),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // 載入使用者列表
        async function loadUsers(search = '', sortBy = currentSort.by, order = currentSort.order) {
            try {
                const params = new URLSearchParams({ sort_by: sortBy, order: order });
                if (search) params.append('search', search);

                const response = await fetch(`/admin/users?${params}`, {
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) throw new Error('載入失敗');

                const data = await response.json();
                usersData = data.users;

                if (usersData.length === 0) {
                    document.getElementById('usersTable').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">👤</div>
                            <h3>尚無使用者資料</h3>
                            <p>目前還沒有任何使用者加入讀經計畫</p>
                        </div>
                    `;
                    return;
                }

                const tableHtml = `
                    <div class="table-container">
                        <div style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
                            <p style="color: #64748b; font-size: 14px;">共 <strong style="color: #0f172a;">${data.total}</strong> 位使用者</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>使用者</th>
                                    <th>讀經計畫</th>
                                    <th>當前天數</th>
                                    <th>進度</th>
                                    <th>最後閱讀</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${usersData.map(user => `
                                    <tr>
                                        <td onclick="showUserDetail('${user.id}')" style="cursor: pointer;">
                                            <div class="user-name">${user.display_name || '未設定'}</div>
                                            <div class="user-id">${user.line_user_id}</div>
                                        </td>
                                        <td onclick="showUserDetail('${user.id}')" style="cursor: pointer;">
                                            <span class="badge ${user.plan_type === 'Canonical' ? 'badge-canonical' : user.plan_type === 'Balanced' ? 'badge-balanced' : 'badge-none'}">
                                                ${user.plan_type === 'Canonical' ? '按卷順序' : user.plan_type === 'Balanced' ? '平衡讀經' : '未選擇'}
                                            </span>
                                        </td>
                                        <td onclick="showUserDetail('${user.id}')" style="cursor: pointer;"><strong>${user.current_day}</strong> / 365</td>
                                        <td onclick="showUserDetail('${user.id}')" style="cursor: pointer;">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${user.progress_percent}%"></div>
                                            </div>
                                            <div class="progress-text">${user.progress_percent}%</div>
                                        </td>
                                        <td onclick="showUserDetail('${user.id}')" style="cursor: pointer;">${user.last_read_date || '尚未開始'}</td>
                                        <td>
                                            <div style="display: flex; gap: 8px; justify-content: center;">
                                                <button class="action-btn action-btn-warning" onclick="event.stopPropagation(); resetQuiz('${user.line_user_id}', '${user.display_name || '未設定'}')" title="重置測驗狀態">
                                                    🔄 測驗
                                                </button>
                                                <button class="action-btn action-btn-danger" onclick="event.stopPropagation(); resetProgress('${user.line_user_id}', '${user.display_name || '未設定'}')" title="重置讀經進度">
                                                    ⚠️ 進度
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('usersTable').innerHTML = tableHtml;

            } catch (error) {
                document.getElementById('usersTable').innerHTML = 
                    `<div class="error">❌ 載入失敗：${error.message}</div>`;
            }
        }

        // 排序使用者
        function sortUsers(sortBy, order) {
            currentSort = { by: sortBy, order: order };
            loadUsers('', sortBy, order);
        }

        // 搜尋功能
        document.addEventListener('DOMContentLoaded', () => {
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.addEventListener('input', (e) => {
                    loadUsers(e.target.value, currentSort.by, currentSort.order);
                });
            }
        });

        // 顯示使用者詳細資料
        async function showUserDetail(userId) {
            try {
                const response = await fetch(`/admin/users/${userId}`, {
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) throw new Error('載入失敗');

                const user = await response.json();

                alert(`
📋 使用者詳細資料

👤 使用者名稱: ${user.display_name || '未設定'}
🆔 LINE User ID: ${user.line_user_id}
📖 讀經計畫: ${user.plan_type === 'Canonical' ? '按卷順序計畫' : user.plan_type === 'Balanced' ? '平衡讀經計畫' : '未選擇'}
📊 當前天數: ${user.current_day} / 365
📈 進度: ${user.progress_percent}%
📅 開始日期: ${user.start_date || '未設定'}
🕒 最後閱讀: ${user.last_read_date || '尚未開始'}
📚 當前閱讀: ${user.current_reading || '無'}
✅ 測驗狀態: ${user.quiz_state}
                `);

            } catch (error) {
                alert('❌ 載入失敗：' + error.message);
            }
        }

        // 載入統計報表
        async function loadStatistics() {
            if (!statsData) {
                await loadDashboard();
            }

            const completionStats = document.getElementById('completionStats');
            completionStats.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>進度區間</th>
                                <th>使用者數</th>
                                <th>百分比</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(statsData.progress_distribution).map(([range, count]) => {
                                const percent = ((count / statsData.total_users) * 100).toFixed(1);
                                return `
                                    <tr>
                                        <td><strong>${range}</strong></td>
                                        <td>${count}</td>
                                        <td>
                                            <div class="progress-bar" style="width: 100px;">
                                                <div class="progress-fill" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="progress-text">${percent}%</div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // 繪製活躍度圖表
            const ctx = document.getElementById('activityChart');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['今日', '本週', '本月'],
                    datasets: [{
                        label: '活躍使用者數',
                        data: [statsData.active_today, statsData.active_week, statsData.active_month],
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // 匯出使用者資料
        function exportUsers() {
            window.open('/admin/export/users', '_blank');
        }

        // 匯出統計報表
        function exportStats() {
            window.open('/admin/export/stats', '_blank');
        }

        // 登出
        function logout() {
            if (confirm('確定要登出嗎？')) {
                sessionStorage.removeItem('adminAuth');
                window.location.href = '/admin/login';
            }
        }

        // 重置測驗狀態
        async function resetQuiz(lineUserId, displayName) {
            if (!confirm(`確定要重置「${displayName}」的測驗狀態嗎？\n\n這將清除該使用者當前的測驗進度，但保留讀經進度。`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/users/${lineUserId}/reset-quiz`, {
                    method: 'POST',
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) throw new Error('重置失敗');

                const result = await response.json();
                alert(`✅ 成功！\n\n${result.message}`);
                
                // 重新載入使用者列表
                loadUsers();

            } catch (error) {
                alert(`❌ 重置失敗：${error.message}`);
            }
        }

        // 重置讀經進度
        async function resetProgress(lineUserId, displayName) {
            if (!confirm(`⚠️ 警告！\n\n確定要重置「${displayName}」的讀經進度嗎？\n\n這將清除該使用者的所有進度，回到第 1 天，此操作無法復原！`)) {
                return;
            }

            // 二次確認
            if (!confirm(`再次確認：真的要重置「${displayName}」的所有進度嗎？`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/users/${lineUserId}/reset-progress`, {
                    method: 'POST',
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) throw new Error('重置失敗');

                const result = await response.json();
                alert(`✅ 成功！\n\n${result.message}`);
                
                // 重新載入使用者列表
                loadUsers();

            } catch (error) {
                alert(`❌ 重置失敗：${error.message}`);
            }
        }

        // 初始載入
        loadDashboard();
    </script>
</body>
</html>

