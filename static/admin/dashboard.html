<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å¾Œå° - Bible Bot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1e293b;
        }

        /* å´é‚Šæ¬„ */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            padding: 30px 0;
            box-shadow: 4px 0 24px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 25px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            text-decoration: none;
        }

        .sidebar-logo-icon {
            width: 42px;
            height: 42px;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .sidebar-logo-text h1 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .sidebar-logo-text p {
            font-size: 12px;
            opacity: 0.8;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .sidebar-menu-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .sidebar-menu-item:hover {
            background: rgba(255,255,255,0.08);
            color: white;
        }

        .sidebar-menu-item.active {
            background: rgba(255,255,255,0.12);
            color: white;
            border-left-color: white;
        }

        .sidebar-menu-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .sidebar-footer {
            position: absolute;
            bottom: 30px;
            left: 0;
            right: 0;
            padding: 0 25px;
        }

        .logout-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.15);
        }

        /* ä¸»å…§å®¹å€ */
        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }

        .top-bar {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar-title h2 {
            font-size: 24px;
            font-weight: 700;
            color: #0f172a;
        }

        .top-bar-title p {
            font-size: 14px;
            color: #64748b;
            margin-top: 4px;
        }

        .top-bar-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .content-area {
            padding: 40px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 28px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.08);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-card-icon.blue {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
        }

        .stat-card-icon.green {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }

        .stat-card-icon.purple {
            background: linear-gradient(135deg, #e9d5ff 0%, #d8b4fe 100%);
        }

        .stat-card-icon.orange {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
        }

        .stat-card-body h3 {
            font-size: 13px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-card-value {
            font-size: 32px;
            font-weight: 800;
            color: #0f172a;
            line-height: 1;
        }

        /* åœ–è¡¨å®¹å™¨ */
        .chart-container {
            background: white;
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            margin-bottom: 24px;
        }

        .chart-header {
            margin-bottom: 24px;
        }

        .chart-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: #0f172a;
        }

        .chart-header p {
            font-size: 14px;
            color: #64748b;
            margin-top: 4px;
        }

        /* æœå°‹æ¡† */
        .search-box {
            width: 100%;
            padding: 14px 18px 14px 48px;
            font-size: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 24px;
            background: white url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%2394a3b8" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 16px center;
            transition: all 0.2s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* è¡¨æ ¼ */
        .table-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8fafc;
        }

        th {
            padding: 16px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e2e8f0;
        }

        td {
            padding: 18px 20px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            color: #334155;
        }

        tr:hover {
            background: #f8fafc;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .user-name {
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 4px;
        }

        .user-id {
            font-size: 12px;
            color: #94a3b8;
            font-family: 'Courier New', monospace;
        }

        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .badge-canonical {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
        }

        .badge-balanced {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }

        .badge-none {
            background: #f1f5f9;
            color: #64748b;
        }

        .progress-bar {
            width: 120px;
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 13px;
            font-weight: 600;
            color: #475569;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f1f5f9;
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 0.8s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: linear-gradient(135deg, #fee 0%, #fdd 100%);
            color: #c53030;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid rgba(197, 48, 48, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 80px 40px;
            color: #94a3b8;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 20px;
            font-weight: 600;
            color: #475569;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 14px;
        }

        /* æ“ä½œæŒ‰éˆ• */
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .action-btn-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }

        .action-btn-warning:hover {
            background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
        }

        .action-btn-danger {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
        }

        .action-btn-danger:hover {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .content-area {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- å´é‚Šæ¬„ -->
    <div class="sidebar">
        <div class="sidebar-header">
            <a href="/" class="sidebar-logo">
                <div class="sidebar-logo-icon">ğŸ“–</div>
                <div class="sidebar-logo-text">
                    <h1>Bible Bot</h1>
                    <p>ç®¡ç†å¾Œå°</p>
                </div>
            </a>
        </div>

        <nav class="sidebar-menu">
            <div class="sidebar-menu-item active" onclick="switchTab('dashboard')">
                <span class="sidebar-menu-icon">ğŸ“Š</span>
                <span>å„€è¡¨æ¿</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTab('users')">
                <span class="sidebar-menu-icon">ğŸ‘¥</span>
                <span>ä½¿ç”¨è€…åˆ—è¡¨</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTab('statistics')">
                <span class="sidebar-menu-icon">ğŸ“ˆ</span>
                <span>çµ±è¨ˆå ±è¡¨</span>
            </div>
            <div class="sidebar-menu-item" onclick="switchTab('export')">
                <span class="sidebar-menu-icon">ğŸ’¾</span>
                <span>è³‡æ–™åŒ¯å‡º</span>
            </div>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()">
                <span>ğŸšª</span>
                <span>ç™»å‡º</span>
            </button>
        </div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <div class="main-content">
        <!-- é ‚éƒ¨æ¬„ -->
        <div class="top-bar">
            <div class="top-bar-title">
                <h2 id="pageTitle">å„€è¡¨æ¿</h2>
                <p id="pageSubtitle">ç¸½è¦½æ‰€æœ‰è®€ç¶“é€²åº¦èˆ‡çµ±è¨ˆè³‡æ–™</p>
            </div>
            <div class="top-bar-actions">
                <button class="btn btn-secondary" onclick="location.reload()">
                    ğŸ”„ é‡æ–°æ•´ç†
                </button>
            </div>
        </div>

        <!-- å…§å®¹å€åŸŸ -->
        <div class="content-area">
            <!-- å„€è¡¨æ¿ -->
            <div id="dashboard" class="tab-content active">
                <div class="stats-grid" id="statsGrid">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>è®€ç¶“è¨ˆç•«åˆ†å¸ƒ</h3>
                        <p>å„è®€ç¶“è¨ˆç•«çš„ä½¿ç”¨è€…äººæ•¸çµ±è¨ˆ</p>
                    </div>
                    <canvas id="planChart"></canvas>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>é€²åº¦åˆ†å¸ƒ</h3>
                        <p>ä½¿ç”¨è€…é–±è®€é€²åº¦çš„åˆ†å¸ƒæƒ…æ³</p>
                    </div>
                    <canvas id="progressChart"></canvas>
                </div>
            </div>

            <!-- ä½¿ç”¨è€…åˆ—è¡¨ -->
            <div id="users" class="tab-content">
                <input type="text" class="search-box" id="searchBox" placeholder="æœå°‹ä½¿ç”¨è€…åç¨±æˆ– LINE ID...">
                
                <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                    <button class="btn btn-secondary" onclick="sortUsers('current_day', 'desc')">
                        ğŸ“Š ä¾é€²åº¦æ’åº
                    </button>
                    <button class="btn btn-secondary" onclick="sortUsers('last_read_date', 'desc')">
                        ğŸ“… ä¾æœ€å¾Œé–±è®€æ’åº
                    </button>
                </div>

                <div id="usersTable">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- çµ±è¨ˆå ±è¡¨ -->
            <div id="statistics" class="tab-content">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>å®Œæˆåº¦çµ±è¨ˆ</h3>
                        <p>å„é€²åº¦å€é–“çš„ä½¿ç”¨è€…åˆ†å¸ƒ</p>
                    </div>
                    <div id="completionStats">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-header">
                        <h3>æ´»èºåº¦è¶¨å‹¢</h3>
                        <p>ä»Šæ—¥ã€æœ¬é€±ã€æœ¬æœˆçš„æ´»èºä½¿ç”¨è€…æ•¸</p>
                    </div>
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <!-- è³‡æ–™åŒ¯å‡º -->
            <div id="export" class="tab-content">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>è³‡æ–™åŒ¯å‡º</h3>
                        <p>åŒ¯å‡ºæ‰€æœ‰ä½¿ç”¨è€…è³‡æ–™å’Œçµ±è¨ˆå ±è¡¨ç‚º CSV æ ¼å¼</p>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-bottom: 32px;">
                        <button class="btn btn-primary" onclick="exportUsers()">
                            ğŸ“¥ åŒ¯å‡ºä½¿ç”¨è€…è³‡æ–™
                        </button>
                        <button class="btn btn-primary" onclick="exportStats()">
                            ğŸ“¥ åŒ¯å‡ºçµ±è¨ˆå ±è¡¨
                        </button>
                    </div>

                    <div style="background: #f8fafc; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0;">
                        <h4 style="font-size: 16px; font-weight: 600; color: #0f172a; margin-bottom: 16px;">ğŸ“‹ åŒ¯å‡ºèªªæ˜</h4>
                        <ul style="list-style: none; padding: 0; color: #475569; line-height: 1.8;">
                            <li style="margin-bottom: 8px;">â€¢ <strong>ä½¿ç”¨è€…è³‡æ–™</strong>ï¼šåŒ…å«æ‰€æœ‰ä½¿ç”¨è€…çš„åç¨±ã€LINE IDã€è®€ç¶“è¨ˆç•«ã€é€²åº¦ã€æ—¥æœŸç­‰è³‡è¨Š</li>
                            <li style="margin-bottom: 8px;">â€¢ <strong>çµ±è¨ˆå ±è¡¨</strong>ï¼šåŒ…å«ç¸½è¦½çµ±è¨ˆã€è¨ˆç•«åˆ†å¸ƒã€é€²åº¦åˆ†å¸ƒç­‰å½™ç¸½è³‡æ–™</li>
                            <li>â€¢ åŒ¯å‡ºçš„ CSV æª”æ¡ˆä½¿ç”¨ UTF-8 ç·¨ç¢¼ï¼Œå¯ç›´æ¥ç”¨ Excel é–‹å•Ÿ</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // èªè­‰æª¢æŸ¥
        const adminAuth = sessionStorage.getItem('adminAuth');
        if (!adminAuth) {
            window.location.href = '/admin/login';
        }

        // å…¨åŸŸè®Šæ•¸
        const authHeader = 'Basic ' + adminAuth;
        let statsData = null;
        let usersData = null;
        let currentSort = { by: 'current_day', order: 'desc' };

        // åˆ‡æ›åˆ†é 
        function switchTab(tabName) {
            // æ›´æ–°å´é‚Šæ¬„é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.sidebar-menu-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.sidebar-menu-item').classList.add('active');

            // æ›´æ–°é ‚éƒ¨æ¨™é¡Œ
            const titles = {
                'dashboard': { title: 'å„€è¡¨æ¿', subtitle: 'ç¸½è¦½æ‰€æœ‰è®€ç¶“é€²åº¦èˆ‡çµ±è¨ˆè³‡æ–™' },
                'users': { title: 'ä½¿ç”¨è€…åˆ—è¡¨', subtitle: 'æŸ¥çœ‹æ‰€æœ‰ä½¿ç”¨è€…çš„è©³ç´°è³‡æ–™' },
                'statistics': { title: 'çµ±è¨ˆå ±è¡¨', subtitle: 'æ·±å…¥åˆ†æè®€ç¶“é€²åº¦èˆ‡æ´»èºåº¦' },
                'export': { title: 'è³‡æ–™åŒ¯å‡º', subtitle: 'åŒ¯å‡ºä½¿ç”¨è€…è³‡æ–™å’Œçµ±è¨ˆå ±è¡¨' }
            };
            document.getElementById('pageTitle').textContent = titles[tabName].title;
            document.getElementById('pageSubtitle').textContent = titles[tabName].subtitle;

            // åˆ‡æ›å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // è¼‰å…¥å°æ‡‰è³‡æ–™
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'statistics') {
                loadStatistics();
            }
        }

        // è¼‰å…¥å„€è¡¨æ¿
        async function loadDashboard() {
            try {
                const response = await fetch('/admin/stats/overview', {
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                statsData = await response.json();

                // é¡¯ç¤ºçµ±è¨ˆå¡ç‰‡
                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon blue">ğŸ‘¥</div>
                        </div>
                        <div class="stat-card-body">
                            <h3>ç¸½ä½¿ç”¨è€…æ•¸</h3>
                            <div class="stat-card-value">${statsData.total_users}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon green">ğŸ“…</div>
                        </div>
                        <div class="stat-card-body">
                            <h3>ä»Šæ—¥æ´»èº</h3>
                            <div class="stat-card-value">${statsData.active_today}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon purple">ğŸ“Š</div>
                        </div>
                        <div class="stat-card-body">
                            <h3>æœ¬é€±æ´»èº</h3>
                            <div class="stat-card-value">${statsData.active_week}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <div class="stat-card-icon orange">ğŸ¯</div>
                        </div>
                        <div class="stat-card-body">
                            <h3>å¹³å‡é€²åº¦</h3>
                            <div class="stat-card-value">${statsData.avg_progress}<span style="font-size: 18px; margin-left: 4px;">å¤©</span></div>
                        </div>
                    </div>
                `;

                // ç¹ªè£½åœ–è¡¨
                drawPlanChart();
                drawProgressChart();

            } catch (error) {
                document.getElementById('statsGrid').innerHTML = 
                    `<div class="error">âŒ è¼‰å…¥å¤±æ•—ï¼š${error.message}</div>`;
            }
        }

        // ç¹ªè£½è¨ˆç•«åˆ†å¸ƒåœ–
        function drawPlanChart() {
            const ctx = document.getElementById('planChart');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statsData.plan_distribution).map(key => {
                        return key === 'Canonical' ? 'æŒ‰å·é †åºè¨ˆç•«' : 
                               key === 'Balanced' ? 'å¹³è¡¡è®€ç¶“è¨ˆç•«' : key;
                    }),
                    datasets: [{
                        data: Object.values(statsData.plan_distribution),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(52, 211, 153, 0.8)',
                            'rgba(251, 146, 60, 0.8)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: { size: 14, family: 'Inter' }
                            }
                        }
                    }
                }
            });
        }

        // ç¹ªè£½é€²åº¦åˆ†å¸ƒåœ–
        function drawProgressChart() {
            const ctx = document.getElementById('progressChart');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(statsData.progress_distribution),
                    datasets: [{
                        label: 'ä½¿ç”¨è€…æ•¸',
                        data: Object.values(statsData.progress_distribution),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }

        // è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
        async function loadUsers(search = '', sortBy = currentSort.by, order = currentSort.order) {
            try {
                const params = new URLSearchParams({ sort_by: sortBy, order: order });
                if (search) params.append('search', search);

                const response = await fetch(`/admin/users?${params}`, {
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                const data = await response.json();
                usersData = data.users;

                if (usersData.length === 0) {
                    document.getElementById('usersTable').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¤</div>
                            <h3>å°šç„¡ä½¿ç”¨è€…è³‡æ–™</h3>
                            <p>ç›®å‰é‚„æ²’æœ‰ä»»ä½•ä½¿ç”¨è€…åŠ å…¥è®€ç¶“è¨ˆç•«</p>
                        </div>
                    `;
                    return;
                }

                const tableHtml = `
                    <div class="table-container">
                        <div style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
                            <p style="color: #64748b; font-size: 14px;">å…± <strong style="color: #0f172a;">${data.total}</strong> ä½ä½¿ç”¨è€…</p>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>ä½¿ç”¨è€…</th>
                                    <th>è®€ç¶“è¨ˆç•«</th>
                                    <th>ç•¶å‰å¤©æ•¸</th>
                                    <th>é€²åº¦</th>
                                    <th>æœ€å¾Œé–±è®€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${usersData.map(user => `
                                    <tr>
                                        <td onclick="showUserDetail('${user.id}')" style="cursor: pointer;">
                                            <div class="user-name">${user.display_name || 'æœªè¨­å®š'}</div>
                                            <div class="user-id">${user.line_user_id}</div>
                                        </td>
                                        <td onclick="showUserDetail('${user.id}')" style="cursor: pointer;">
                                            <span class="badge ${user.plan_type === 'Canonical' ? 'badge-canonical' : user.plan_type === 'Balanced' ? 'badge-balanced' : 'badge-none'}">
                                                ${user.plan_type === 'Canonical' ? 'æŒ‰å·é †åº' : user.plan_type === 'Balanced' ? 'å¹³è¡¡è®€ç¶“' : 'æœªé¸æ“‡'}
                                            </span>
                                        </td>
                                        <td onclick="showUserDetail('${user.id}')" style="cursor: pointer;"><strong>${user.current_day}</strong> / 365</td>
                                        <td onclick="showUserDetail('${user.id}')" style="cursor: pointer;">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: ${user.progress_percent}%"></div>
                                            </div>
                                            <div class="progress-text">${user.progress_percent}%</div>
                                        </td>
                                        <td onclick="showUserDetail('${user.id}')" style="cursor: pointer;">${user.last_read_date || 'å°šæœªé–‹å§‹'}</td>
                                        <td>
                                            <div style="display: flex; gap: 8px; justify-content: center;">
                                                <button class="action-btn action-btn-warning" onclick="event.stopPropagation(); resetQuiz('${user.line_user_id}', '${user.display_name || 'æœªè¨­å®š'}')" title="é‡ç½®æ¸¬é©—ç‹€æ…‹">
                                                    ğŸ”„ æ¸¬é©—
                                                </button>
                                                <button class="action-btn action-btn-danger" onclick="event.stopPropagation(); resetProgress('${user.line_user_id}', '${user.display_name || 'æœªè¨­å®š'}')" title="é‡ç½®è®€ç¶“é€²åº¦">
                                                    âš ï¸ é€²åº¦
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                document.getElementById('usersTable').innerHTML = tableHtml;

            } catch (error) {
                document.getElementById('usersTable').innerHTML = 
                    `<div class="error">âŒ è¼‰å…¥å¤±æ•—ï¼š${error.message}</div>`;
            }
        }

        // æ’åºä½¿ç”¨è€…
        function sortUsers(sortBy, order) {
            currentSort = { by: sortBy, order: order };
            loadUsers('', sortBy, order);
        }

        // æœå°‹åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            const searchBox = document.getElementById('searchBox');
            if (searchBox) {
                searchBox.addEventListener('input', (e) => {
                    loadUsers(e.target.value, currentSort.by, currentSort.order);
                });
            }
        });

        // é¡¯ç¤ºä½¿ç”¨è€…è©³ç´°è³‡æ–™
        async function showUserDetail(userId) {
            try {
                const response = await fetch(`/admin/users/${userId}`, {
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) throw new Error('è¼‰å…¥å¤±æ•—');

                const user = await response.json();

                alert(`
ğŸ“‹ ä½¿ç”¨è€…è©³ç´°è³‡æ–™

ğŸ‘¤ ä½¿ç”¨è€…åç¨±: ${user.display_name || 'æœªè¨­å®š'}
ğŸ†” LINE User ID: ${user.line_user_id}
ğŸ“– è®€ç¶“è¨ˆç•«: ${user.plan_type === 'Canonical' ? 'æŒ‰å·é †åºè¨ˆç•«' : user.plan_type === 'Balanced' ? 'å¹³è¡¡è®€ç¶“è¨ˆç•«' : 'æœªé¸æ“‡'}
ğŸ“Š ç•¶å‰å¤©æ•¸: ${user.current_day} / 365
ğŸ“ˆ é€²åº¦: ${user.progress_percent}%
ğŸ“… é–‹å§‹æ—¥æœŸ: ${user.start_date || 'æœªè¨­å®š'}
ğŸ•’ æœ€å¾Œé–±è®€: ${user.last_read_date || 'å°šæœªé–‹å§‹'}
ğŸ“š ç•¶å‰é–±è®€: ${user.current_reading || 'ç„¡'}
âœ… æ¸¬é©—ç‹€æ…‹: ${user.quiz_state}
                `);

            } catch (error) {
                alert('âŒ è¼‰å…¥å¤±æ•—ï¼š' + error.message);
            }
        }

        // è¼‰å…¥çµ±è¨ˆå ±è¡¨
        async function loadStatistics() {
            if (!statsData) {
                await loadDashboard();
            }

            const completionStats = document.getElementById('completionStats');
            completionStats.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>é€²åº¦å€é–“</th>
                                <th>ä½¿ç”¨è€…æ•¸</th>
                                <th>ç™¾åˆ†æ¯”</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(statsData.progress_distribution).map(([range, count]) => {
                                const percent = ((count / statsData.total_users) * 100).toFixed(1);
                                return `
                                    <tr>
                                        <td><strong>${range}</strong></td>
                                        <td>${count}</td>
                                        <td>
                                            <div class="progress-bar" style="width: 100px;">
                                                <div class="progress-fill" style="width: ${percent}%"></div>
                                            </div>
                                            <div class="progress-text">${percent}%</div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            // ç¹ªè£½æ´»èºåº¦åœ–è¡¨
            const ctx = document.getElementById('activityChart');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['ä»Šæ—¥', 'æœ¬é€±', 'æœ¬æœˆ'],
                    datasets: [{
                        label: 'æ´»èºä½¿ç”¨è€…æ•¸',
                        data: [statsData.active_today, statsData.active_week, statsData.active_month],
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // åŒ¯å‡ºä½¿ç”¨è€…è³‡æ–™
        function exportUsers() {
            window.open('/admin/export/users', '_blank');
        }

        // åŒ¯å‡ºçµ±è¨ˆå ±è¡¨
        function exportStats() {
            window.open('/admin/export/stats', '_blank');
        }

        // ç™»å‡º
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                sessionStorage.removeItem('adminAuth');
                window.location.href = '/admin/login';
            }
        }

        // é‡ç½®æ¸¬é©—ç‹€æ…‹
        async function resetQuiz(lineUserId, displayName) {
            if (!confirm(`ç¢ºå®šè¦é‡ç½®ã€Œ${displayName}ã€çš„æ¸¬é©—ç‹€æ…‹å—ï¼Ÿ\n\né€™å°‡æ¸…é™¤è©²ä½¿ç”¨è€…ç•¶å‰çš„æ¸¬é©—é€²åº¦ï¼Œä½†ä¿ç•™è®€ç¶“é€²åº¦ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/users/${lineUserId}/reset-quiz`, {
                    method: 'POST',
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) throw new Error('é‡ç½®å¤±æ•—');

                const result = await response.json();
                alert(`âœ… æˆåŠŸï¼\n\n${result.message}`);
                
                // é‡æ–°è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
                loadUsers();

            } catch (error) {
                alert(`âŒ é‡ç½®å¤±æ•—ï¼š${error.message}`);
            }
        }

        // é‡ç½®è®€ç¶“é€²åº¦
        async function resetProgress(lineUserId, displayName) {
            if (!confirm(`âš ï¸ è­¦å‘Šï¼\n\nç¢ºå®šè¦é‡ç½®ã€Œ${displayName}ã€çš„è®€ç¶“é€²åº¦å—ï¼Ÿ\n\né€™å°‡æ¸…é™¤è©²ä½¿ç”¨è€…çš„æ‰€æœ‰é€²åº¦ï¼Œå›åˆ°ç¬¬ 1 å¤©ï¼Œæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) {
                return;
            }

            // äºŒæ¬¡ç¢ºèª
            if (!confirm(`å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦é‡ç½®ã€Œ${displayName}ã€çš„æ‰€æœ‰é€²åº¦å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/users/${lineUserId}/reset-progress`, {
                    method: 'POST',
                    headers: { 'Authorization': authHeader }
                });

                if (!response.ok) throw new Error('é‡ç½®å¤±æ•—');

                const result = await response.json();
                alert(`âœ… æˆåŠŸï¼\n\n${result.message}`);
                
                // é‡æ–°è¼‰å…¥ä½¿ç”¨è€…åˆ—è¡¨
                loadUsers();

            } catch (error) {
                alert(`âŒ é‡ç½®å¤±æ•—ï¼š${error.message}`);
            }
        }

        // åˆå§‹è¼‰å…¥
        loadDashboard();
    </script>
</body>
</html>

