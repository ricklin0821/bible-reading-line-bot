# 📚 小組功能使用指南

## 🎯 小組功能指令列表

### 基本功能

| 指令 | 說明 | 別名 |
|------|------|------|
| `加入小組` | 隨機加入一個讀經小組（最多6人） | `👥 加入小組`, `小組` |
| `小組資訊` | 查看目前小組的成員和資訊 | `👥 小組資訊`, `我的小組` |
| `離開小組` | 離開目前的小組 | `退出小組` |
| `換組` | 離開目前小組並隨機加入新小組 | `🔄 換組`, `隨機換組` |

### 留言功能

| 指令 | 說明 | 別名 |
|------|------|------|
| `小組留言` | 進入留言模式，發送訊息給組員 | `💬 小組留言`, `留言板` |
| `留言歷史` | 查看最近10則小組留言 | `查看留言` |
| `取消` | 離開留言模式 | `離開`, `退出` |

### 通知設定

| 指令 | 說明 | 別名 |
|------|------|------|
| `小組通知開啟` | 開啟小組通知（組員完成讀經時會收到通知） | `開啟小組通知` |
| `小組通知關閉` | 關閉小組通知 | `關閉小組通知` |

---

## 📝 使用流程

### 1. 加入小組

```
使用者：加入小組
機器人：🎉 歡迎加入小組！

您已成功加入小組！

💡 小組功能：
• 當組員完成讀經時，會通知其他成員
• 可以在小組留言板互相鼓勵
• 發送「小組資訊」查看成員
• 發送「小組留言」進入留言模式
```

### 2. 查看小組資訊

```
使用者：小組資訊
機器人：👥 小組資訊

📊 人數：3/6

👤 成員列表：
1. 張三 🔔
2. 李四 🔔
3. 王五 🔕

💡 提示：
• 發送「小組留言」進入留言模式
• 發送「換組」可以隨機換到新小組
• 發送「小組通知關閉」可關閉通知
```

### 3. 發送小組留言

```
使用者：小組留言
機器人：📝 已進入小組留言模式

請輸入您想說的話，將會發送給所有小組成員

發送「取消」離開留言模式

使用者：今天的經文很有感動！
機器人：✅ 已發送留言給 2 位組員

您的留言：
今天的經文很有感動！
```

### 4. 查看留言歷史

```
使用者：留言歷史
機器人：💬 小組留言板

👤 張三 (2025-11-10 10:30)
今天的經文很有感動！

👤 李四 (2025-11-10 09:15)
大家加油！一起讀經成長！

👤 王五 (2025-11-09 22:00)
感謝神的帶領
```

---

## 🔔 小組通知功能

### 完成讀經通知

當您完成讀經測驗後，系統會自動通知小組其他成員（如果他們開啟通知）：

```
📢 小組通知

您的組員 張三 完成了今天的讀經！

目前進度：第 45 天
連續天數：7 天

一起為他加油！💪
```

### 關閉通知

如果不想收到通知，可以發送：

```
使用者：小組通知關閉
機器人：🔕 小組通知已關閉

您將不會收到組員完成讀經的通知
```

---

## 🌐 後台管理功能

管理員可以透過後台 API 查詢小組資料：

### API 端點

| 端點 | 說明 | 方法 |
|------|------|------|
| `/admin/groups` | 取得所有小組列表 | GET |
| `/admin/groups/{group_id}` | 取得特定小組詳細資料 | GET |
| `/admin/groups/stats/overview` | 取得小組統計資料 | GET |
| `/admin/export/groups` | 匯出小組資料為 CSV | GET |

### 範例：查詢所有小組

```bash
curl -u admin:password https://your-domain.com/admin/groups
```

回應：
```json
{
  "total": 5,
  "groups": [
    {
      "group_id": "group_20251110_120000_abc1",
      "member_count": 6,
      "max_members": 6,
      "is_full": true,
      "created_at": "2025-11-10T12:00:00",
      "members": [
        {
          "user_id": "U1234567890",
          "display_name": "張三",
          "joined_at": "2025-11-10T12:00:00",
          "notification_enabled": true
        }
      ]
    }
  ]
}
```

### 範例：查詢小組統計

```bash
curl -u admin:password https://your-domain.com/admin/groups/stats/overview
```

回應：
```json
{
  "total_groups": 5,
  "total_members": 18,
  "full_groups": 2,
  "avg_members_per_group": 3.6,
  "member_distribution": {
    "1": 0,
    "2": 1,
    "3": 2,
    "4": 1,
    "5": 0,
    "6": 2
  },
  "total_messages": 45
}
```

---

## ⚙️ 技術細節

### 資料庫結構

#### groups 集合

```json
{
  "group_id": "group_20251110_120000_abc1",
  "created_at": "2025-11-10T12:00:00",
  "member_count": 3,
  "max_members": 6,
  "is_full": false,
  "members": [
    {
      "user_id": "U1234567890",
      "display_name": "張三",
      "joined_at": "2025-11-10T12:00:00",
      "notification_enabled": true
    }
  ]
}
```

#### group_messages 集合

```json
{
  "group_id": "group_20251110_120000_abc1",
  "user_id": "U1234567890",
  "display_name": "張三",
  "content": "今天的經文很有感動！",
  "message_type": "text",
  "created_at": "2025-11-10T12:30:00"
}
```

#### users 集合（新增欄位）

```json
{
  "line_user_id": "U1234567890",
  "group_id": "group_20251110_120000_abc1",
  "group_notification_enabled": true,
  "group_message_state": "IDLE",
  "joined_group_at": "2025-11-10T12:00:00"
}
```

---

## 💡 常見問題

### Q: 如何查看我在哪個小組？
A: 發送「小組資訊」即可查看。

### Q: 可以同時加入多個小組嗎？
A: 不行，每個使用者只能加入一個小組。

### Q: 如何換到另一個小組？
A: 發送「換組」即可隨機換到新小組。

### Q: 留言歷史可以保存多久？
A: 目前沒有時間限制，所有留言都會保存在資料庫中。

### Q: 如何關閉小組通知？
A: 發送「小組通知關閉」即可。

---

## 📊 功能統計

- ✅ 小組最大人數：6 人
- ✅ 留言歷史顯示：最近 10 則
- ✅ 自動通知：完成讀經時通知組員
- ✅ 隨機分配：自動加入未滿的小組
- ✅ 後台管理：完整的 API 支援

---

**最後更新**：2025-11-10  
**版本**：v1.0
