# 🚀 小組功能部署與測試指南

## 📋 部署步驟

### 步驟 1: 拉取最新程式碼

```bash
cd C:\Users\rickl\OneDrive\Documents\bible-reading-line-bot
git pull origin master
```

### 步驟 2: 部署到 Cloud Run

```bash
gcloud run deploy bible-bot --source . --region asia-east1 --project bible-bot-project
```

⏳ **預計時間**：3-5 分鐘

---

## ✅ 測試清單

### 1. 基礎功能測試

#### 1.1 加入小組
- [ ] 發送：`加入小組`
- [ ] 確認收到歡迎訊息
- [ ] 確認訊息包含小組功能說明

**預期回應**：
```
🎉 歡迎加入小組！

您已成功創建並加入新小組！

💡 小組功能：
• 當組員完成讀經時，會通知其他成員
• 可以在小組留言板互相鼓勵
• 發送「小組資訊」查看成員
• 發送「小組留言」進入留言模式
```

#### 1.2 查看小組資訊
- [ ] 發送：`小組資訊`
- [ ] 確認顯示小組 ID
- [ ] 確認顯示自己的資訊

**預期回應**：
```
👥 小組資訊

小組 ID: xxx

成員列表：
1. [您的名字] ⭐⭐⭐
   總積分: XXX | 連續: X天
```

---

### 2. 完成讀經通知測試

#### 2.1 單人測試
- [ ] 完成一次讀經測驗
- [ ] 確認沒有收到通知（因為小組只有自己）

#### 2.2 多人測試（需要另一個帳號）
- [ ] 用另一個帳號加入小組
- [ ] 確認兩個帳號在同一組
- [ ] 用帳號 A 完成讀經
- [ ] 確認帳號 B 收到通知

**預期通知**：
```
🎉 小組通知

[帳號A名字] 剛剛完成了今日讀經！

一起為他加油鼓勵吧！💪
```

---

### 3. 留言板功能測試

#### 3.1 發送留言
- [ ] 發送：`小組留言`
- [ ] 確認進入留言模式
- [ ] 輸入：`測試留言`
- [ ] 確認收到發送成功訊息

**預期流程**：
```
使用者：小組留言

Bot：📝 已進入小組留言模式

請輸入您想說的話，將會發送給所有小組成員

發送「取消」離開留言模式

---

使用者：測試留言

Bot：✅ 留言已發送給 X 位小組成員！
```

#### 3.2 取消留言
- [ ] 發送：`小組留言`
- [ ] 輸入：`取消`
- [ ] 確認離開留言模式

**預期回應**：
```
✅ 已離開留言模式
```

#### 3.3 查看留言歷史
- [ ] 發送：`留言歷史`
- [ ] 確認顯示之前的留言
- [ ] 確認顯示完成讀經記錄

**預期回應**：
```
💬 小組留言板

✅ [名字] (11/07 10:30)
[名字] 完成了今日讀經

💬 [名字] (11/07 10:35)
測試留言

---
發送「小組留言」繼續互動
```

---

### 4. 小組管理功能測試

#### 4.1 換組
- [ ] 發送：`換組`
- [ ] 確認收到換組成功訊息
- [ ] 發送：`小組資訊`
- [ ] 確認小組 ID 已改變

**預期回應**：
```
✅ 換組成功！

您已加入新的小組！

發送「小組資訊」查看新組員
```

#### 4.2 離開小組
- [ ] 發送：`離開小組`
- [ ] 確認收到離開訊息
- [ ] 發送：`小組資訊`
- [ ] 確認提示尚未加入小組

**預期回應**：
```
👋 您已離開小組

隨時都可以發送「加入小組」重新加入！
```

---

### 5. 通知設定測試

#### 5.1 關閉通知
- [ ] 先加入小組：`加入小組`
- [ ] 發送：`小組通知關閉`
- [ ] 確認收到關閉成功訊息

**預期回應**：
```
🔕 小組通知已關閉

您將不會收到組員完成讀經的通知
```

#### 5.2 開啟通知
- [ ] 發送：`小組通知開啟`
- [ ] 確認收到開啟成功訊息

**預期回應**：
```
🔔 小組通知已開啟

當組員完成讀經時，您會收到通知！
```

---

### 6. 整合測試（需要多個帳號）

#### 6.1 3人小組測試
- [ ] 3個帳號都加入小組
- [ ] 確認都在同一組
- [ ] 帳號 A 完成讀經
- [ ] 確認帳號 B 和 C 都收到通知
- [ ] 帳號 B 發送留言
- [ ] 確認帳號 A 和 C 都收到留言

#### 6.2 滿組測試（6人）
- [ ] 6個帳號加入同一組
- [ ] 確認第7個帳號會創建新組
- [ ] 測試通知是否正常

---

## 🐛 常見問題排查

### 問題 1: 加入小組失敗

**可能原因**：
- Firestore 權限問題
- 網路連線問題

**排查步驟**：
1. 檢查 Cloud Run 日誌
2. 確認 Firestore 已啟用
3. 檢查 database.py 中的 Firestore 連線

### 問題 2: 沒有收到通知

**可能原因**：
- 通知已關閉
- 小組只有自己
- LINE API 錯誤

**排查步驟**：
1. 確認通知設定：`小組通知開啟`
2. 確認小組有其他成員：`小組資訊`
3. 檢查 Cloud Run 日誌中的錯誤訊息

### 問題 3: 留言沒有發送

**可能原因**：
- 小組 ID 遺失
- Push Message API 錯誤

**排查步驟**：
1. 確認在小組中：`小組資訊`
2. 檢查 Cloud Run 日誌
3. 確認 LINE Channel Access Token 正確

### 問題 4: 無法換組

**可能原因**：
- 沒有其他小組
- 資料庫更新失敗

**排查步驟**：
1. 檢查 Firestore 中的 groups collection
2. 確認至少有 2 個小組存在
3. 檢查 Cloud Run 日誌

---

## 📊 監控指標

### 1. Cloud Run 日誌

查看關鍵日誌：
```bash
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=bible-bot" --limit 50 --format json
```

**關鍵訊息**：
- `[DEBUG] 已通知 X 位小組成員`
- `[ERROR] 小組通知失敗`
- `💾 已儲存小組訊息`

### 2. Firestore 資料檢查

**Groups Collection**：
- 確認有新的 group 文件
- 確認 members 陣列正確
- 確認 member_count 正確

**Group Messages Collection**：
- 確認有留言記錄
- 確認 message_type 正確
- 確認 created_at 時間正確

**Users Collection**：
- 確認 group_id 欄位存在
- 確認 group_message_state 欄位存在
- 確認 notification_enabled 欄位存在

### 3. LINE API 使用量

前往 [LINE Developers Console](https://developers.line.biz/console/)：
1. 選擇您的 Channel
2. 查看 Messaging API → Statistics
3. 確認 Push messages 數量增加

---

## 🎯 測試完成檢查表

- [ ] 所有基礎功能測試通過
- [ ] 完成讀經通知正常
- [ ] 留言板功能正常
- [ ] 小組管理功能正常
- [ ] 通知設定功能正常
- [ ] 多人整合測試通過
- [ ] Cloud Run 日誌無錯誤
- [ ] Firestore 資料正確
- [ ] LINE API 使用量正常

---

## 📝 測試報告範本

```
# 小組功能測試報告

測試日期：2025-11-07
測試人員：[您的名字]

## 測試環境
- Cloud Run Service: bible-bot
- Region: asia-east1
- LINE Bot: [Bot 名稱]

## 測試結果

### 基礎功能
- [x] 加入小組：✅ 通過
- [x] 查看小組資訊：✅ 通過
- [ ] 換組：❌ 失敗 - [錯誤描述]
- [x] 離開小組：✅ 通過

### 通知功能
- [x] 完成讀經通知：✅ 通過
- [x] 通知開關：✅ 通過

### 留言板
- [x] 發送留言：✅ 通過
- [x] 查看歷史：✅ 通過
- [x] 取消留言：✅ 通過

## 發現的問題

1. [問題描述]
   - 重現步驟：...
   - 預期結果：...
   - 實際結果：...
   - 錯誤訊息：...

## 建議

1. [改進建議]
2. [優化建議]

## 總結

[整體測試結論]
```

---

## 🚀 測試完成後

測試完成並確認無誤後，請回報測試結果，我們將繼續實作成就系統！

如果發現任何問題，請提供：
1. 錯誤訊息截圖
2. Cloud Run 日誌
3. 操作步驟

我會立即協助修正！🔧
